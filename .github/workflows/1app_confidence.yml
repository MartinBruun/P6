name: App Confidence

# App confidence continious integration testing
# Confidence testing are for getting quick feedback

on:
  pull_request:
    paths:
      - 'washee_app/**'

env:
  MIN_COVERAGE: "Last set to 13, but don't know how to inject as environment variable"

jobs:
  app_confidence:
    runs-on: ubuntu-latest

    steps:
    # SETUP
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: '12.x'
    
    - uses: subosito/flutter-action@v1
      with:
        channel: 'stable' # 'dev', 'alpha', or 'stable' default to: 'stable'
        flutter-version: '3.0.2' # set to the flutter version of MartinBruun due to previous errors
    
    - name: Necessary App environment files
      working-directory: ./washee_app
      run: |
        echo Necessary development environment to satisfy flutter assets > .env.dev
        echo Necessary production environment to satisfy flutter assets > .env.prod

    # TESTING

    - name: Lint according to analysis_options.yaml rules
      working-directory: ./washee_app
      run: |
        flutter analyze

    - name: Run flutter tests and check for minimum coverage afterwards
      working-directory: ./washee_app
      run: |
        flutter pub get
        flutter test --coverage

    - uses: VGVentures/very-good-coverage@v1.1.1
      with:
        path: "./washee_app/coverage/lcov.info"
        min_coverage: 100
        exclude: "**/*_observer.dart **/change.dart"